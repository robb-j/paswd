<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Password Generator</title>
    <link rel="stylesheet" href="https://fonts.openlab.dev/rubik/rubik.css" />
    <link rel="stylesheet" href="https://alembic.openlab.dev/labcoat.css" />
    <meta name="theme-color" content="#49D49D" />
    <link rel="icon" href="icon.svg" />
    <meta
      name="description"
      content="Quickly generate secure passwords in your browser with no dodgy stuff"
    />
    <link rel="manifest" href="app.webmanifest" />
    <style>
      :root {
        --theme: #49d49d;
        --focus: #b248d4;
        --anchor: #d45f48;
        --font-main: "Rubik var", Rubik, Inter, system-ui, sans-serif;
      }
      input[readonly] {
        border-color: var(--border);
        border-style: dashed;
      }
      body > header {
        background: var(--theme) !important;
        padding: 0.5em;
        font-weight: bold;
        line-height: 1;
        color: #242729;
      }
      button {
        appearance: none;
        padding: var(--s-5) var(--s0);
        margin: 0;
        border: var(--border-thin) solid black;
        box-shadow: 3px 3px black;
        background-color: #69ebd0;
        font-family: var(--font-mono);
        color: black;
        font-weight: bold;
      }
      .field-label {
        font-style: normal;
        font-weight: 600;
        font-variant-numeric: tabular-nums;
      }
      .entropy {
        font-style: italic;
        text-decoration-style: dashed;
        opacity: 0.7;
        color: var(--anchor);
      }
      label.checkbox {
        padding-inline-start: 0;
      }
      input[type="range"] {
        outline-offset: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <header>Password Generator</header>

    <main>
      <center-layout>
        <stack-layout space="s3">
          <section>
            <h1>Generate passwords</h1>
            <p>
              This page has a few tools for generating passwords using different
              strategies. No trackers, adverts, KPIs or metrics. A simple HTML,
              CSS and JavaScript website with useful tools.
            </p>
          </section>

          <!-- 
            WORDS
           -->

          <section class="flow">
            <header>
              <h2>Words</h2>
              <p>
                Pick four random English words between 4 and 8 characters long
              </p>
            </header>

            <!-- <label class="checkbox" for="capitalizeWord">
              <input type="checkbox" id="capitalizeWord" name="capitalizeWord" checked>
              <span>Capitalize a word</span>
            </label> -->

            <label class="checkbox" for="pronouncableWord">
              <input type="checkbox" id="pronouncableWord" name="pronouncableWord" checked>
              <span>Use pronouncable words</span>
            </label>

            <label class="field" for="wordLength">
              <span class="field-label">4 words</span>
              <input type="range" id="wordLength" name="wordLength" min="1" max="10" value="4">
            </label>

            <cluster-layout space="s-1">
              <button onclick="generateWords()">Generate</button>
              <button onclick="copyValue('words')">Copy</button>
            </cluster-layout>

            <label class="field" for="words">
              <span class="field-label">Output</span>
              <input type="text" readonly id="words" name="words" />
              <span class="field-hint"></span>
            </label>
          </section>

          <!--
            UUID
           -->

          <section class="flow">
            <header>
              <h2>UUID</h2>
              <p>Use <code>crypto.randomUUID()</code> to generate a secret</p>
            </header>

            <cluster-layout space="s-1">
              <button onclick="generateUUID()">Generate</button>
              <button onclick="copyValue('uuid')">Copy</button>
            </cluster-layout>

            <label class="field" for="uuid">
              <span class="field-label">Output</span>
              <input type="text" readonly id="uuid" name="uuid" />
            </label>
          </section>

          <!-- 
            AES
           -->

          <section class="flow">
            <header>
              <h2>AES-GCM</h2>
              <p>
                Use <code>crypto.subtle.generateKey()</code> to generate and
                export an <code>AES-GCM</code> key then use the
                <code>k</code> component of the JWK
              </p>
            </header>

            <cluster-layout space="s-1">
              <button onclick="generateAES()">Generate</button>
              <button onclick="copyValue('aes')">Copy</button>
            </cluster-layout>

            <label class="field" for="aes">
              <span class="field-label">Output</span>
              <input type="text" readonly id="aes" name="aes" />
            </label>
          </section>
        </stack-layout>
      </center-layout>
    </main>

    <footer>
      Made by <a href="https://www.r0b.io">Rob</a>
      &bullet;
      <a href="https://github.com/robb-j/paswd">Open Source</a>
      &bullet;
      <span id="meta"></span>
    </footer>

    <script
      type="module"
      src="https://alembic.openlab.dev/everything.js"
    ></script>

    <script type="module">
      const words = {
        all: fetch("./words.json").then((r) => r.json()),
        bip39: fetch("./bip-39.json").then((r) => r.json())
      }

      // Pick a random integer from 0 up-to but NOT including "length"
      function randomInteger(length) {
        return crypto.getRandomValues(new Uint32Array(1))[0] % length;
      }

      window.generateUUID = () => {
        setPassword("uuid", crypto.randomUUID())
      };
      window.generateAES = async () => {
        const key = await crypto.subtle.generateKey(
          { name: "AES-GCM", length: 256 },
          true,
          ["encrypt", "decrypt"],
        );
        const value = await crypto.subtle.exportKey("jwk", key);

        setPassword("aes", value.k)
      };
      window.generateWords = async () => {
        const length = document.getElementById('wordLength').valueAsNumber

        const pronouncable = document.getElementById('pronouncableWord').checked
        const corpus = await (pronouncable ? words.bip39 : words.all)
        const entropy = Math.log2(Math.pow(corpus.length, length * length))

        const value = [];
        for (let i = 0; i < length; i++) {
          value.push(corpus[randomInteger(corpus.length)]);
        }

        // if (document.getElementById('capitalizeWord')?.checked) {
        const upper = randomInteger(Math.max(length, 2));
        if (value[upper]) value[upper] = value[upper].toUpperCase();
        // }

        setPassword("words", value.join("-"), entropy)
      };
      window.copyValue = async (id) => {
        const input = document.getElementById(id);
        await navigator.clipboard.write([
          new ClipboardItem({ "text/plain": input.value }),
        ]);
        const label = input.parentElement.querySelector(".field-label");
        label.textContent = "Output (copied)";
        await new Promise((r) => setTimeout(r, 4_000));
        label.textContent = "Output";
      };
      window.setPassword = (id, value, entropy) => {
        const input = document.getElementById(id)
        input.value = value

        const hint = input.parentElement.querySelector('.field-hint')
        if (hint && entropy) {
          hint.innerHTML = `
            <a href="https://en.wikipedia.org/wiki/Entropy_(information_theory)" class="entropy" target="_blank">
              ${entropy} bits of entropy
            </a>
          `
        }
      }

      function updateWordLength(el) {
        const value = el.valueAsNumber
        const elem = el.parentElement.querySelector('.field-label')
        elem.textContent = value === 1 ? `1 word` : `${value} words`
      }

      generateUUID();
      generateAES();
      generateWords();

      document.getElementById('wordLength').addEventListener('input',
        e => updateWordLength(e.target)
      )
      updateWordLength(document.getElementById('wordLength'))
    </script>

    <script type="module">
      import meta from "./app.json" with { type: "json" };

      // Put the version in the footer
      const metaElement = document.querySelector("#meta");
      if (metaElement) metaElement.textContent = "v" + meta.version;

      // Register the service worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js", { scope: "/", type: "module" })
          .catch((error) =>
            console.error("Failed to register ServiceWorker", error),
          );
      }
    </script>
  </body>
</html>
